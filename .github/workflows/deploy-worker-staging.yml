name: Deploy Worker to Staging

env:
  APP_NAME: qarote-worker-staging
  BACKEND_APP_NAME: qarote-staging

on:
  push:
    branches: [main]
    paths:
      - "apps/api/**"
      - "apps/api/app.worker.json"
      - ".github/workflows/deploy-worker-staging.yml"
  workflow_dispatch:

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Check package version consistency
        run: pnpm run syncpack:check

      - name: ğŸ” Type Check
        working-directory: apps/api
        run: pnpm run type-check

      - name: ğŸ§¹ Lint
        working-directory: apps/api
        run: pnpm run lint

      - name: ğŸ’… Format Check
        working-directory: apps/api
        run: pnpm run format

      - name: ğŸ§ª Run Tests
        working-directory: apps/api
        run: pnpm run test:run

  configure-worker-app:
    name: Configure Worker App
    runs-on: ubuntu-latest
    environment: staging
    needs: quality-checks

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: ğŸ—ï¸ Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.DOKKU_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ—ï¸ Ensure app exists
        run: |
          ssh dokku@${{ vars.DOKKU_HOST }} apps:create ${{ env.APP_NAME }} || \
            echo "App already exists or creation failed"

      - name: ğŸ”— Link to staging database
        run: |
          echo "Removing any stale DATABASE_URL..."
          ssh dokku@${{ vars.DOKKU_HOST }} config:unset ${{ env.APP_NAME }} DATABASE_URL || \
            echo "DATABASE_URL not set (this is OK)"
          echo "Linking worker app to staging database (rabbit-hq-db)..."
          ssh dokku@${{ vars.DOKKU_HOST }} postgres:link rabbit-hq-db ${{ env.APP_NAME }} || \
            echo "Database link may already exist (this is OK)"
          echo "Ensuring DATABASE_URL is set from postgres link..."
          DATABASE_URL=$(ssh dokku@${{ vars.DOKKU_HOST }} config:get ${{ env.APP_NAME }} DOKKU_POSTGRES_AQUA_URL)
          if [ -n "$DATABASE_URL" ]; then
            ssh dokku@${{ vars.DOKKU_HOST }} config:set ${{ env.APP_NAME }} DATABASE_URL="$DATABASE_URL"
          fi

      - name: ğŸ“ Configure Environment Variables
        run: |
          ssh dokku@${{ vars.DOKKU_HOST }} config:set ${{ env.APP_NAME }} \
            DOMAIN_BACKEND=${{ vars.DOMAIN_BACKEND }} \
            DOMAIN_FRONTEND=${{ vars.DOMAIN_FRONTEND }} \
            PORT=${{ vars.PORT }} \
            HOST=${{ vars.HOST }} \
            NODE_ENV=${{ vars.NODE_ENV }} \
            ENVIRONMENT=staging \
            LOG_LEVEL=${{ vars.LOG_LEVEL }} \
            JWT_SECRET=${{ secrets.JWT_SECRET }} \
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }} \
            CORS_ORIGIN=${{ vars.CORS_ORIGIN }} \
            FRONTEND_URL=${{ vars.FRONTEND_URL }} \
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }} \
            FROM_EMAIL=${{ vars.FROM_EMAIL }} \
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }} \
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }} \
            STRIPE_DEVELOPER_MONTHLY_PRICE_ID=${{ vars.STRIPE_DEVELOPER_MONTHLY_PRICE_ID }} \
            STRIPE_DEVELOPER_YEARLY_PRICE_ID=${{ vars.STRIPE_DEVELOPER_YEARLY_PRICE_ID }} \
            STRIPE_ENTERPRISE_MONTHLY_PRICE_ID=${{ vars.STRIPE_ENTERPRISE_MONTHLY_PRICE_ID }} \
            STRIPE_ENTERPRISE_YEARLY_PRICE_ID=${{ vars.STRIPE_ENTERPRISE_YEARLY_PRICE_ID }} \
            SENTRY_DSN=${{ vars.SENTRY_DSN }} \
            SENTRY_ENABLED=${{ vars.SENTRY_ENABLED }} \
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }} \
            NOTION_API_KEY=${{ secrets.NOTION_API_KEY }} \
            NOTION_DATABASE_ID=${{ vars.NOTION_DATABASE_ID }} \
            NOTION_SYNC_ENABLED=${{ vars.NOTION_SYNC_ENABLED }} \
            ENABLE_NOTION=${{ vars.ENABLE_NOTION }} \
            NODE_ID=app1

      - name: ğŸš« Configure worker app to use app.worker.json
        run: |
          echo "Configuring worker app to use app.worker.json (without predeploy hook)..."
          ssh dokku@${{ vars.DOKKU_HOST }} app-json:set ${{ env.APP_NAME }} appjson-path app.worker.json

  deploy-worker:
    name: Deploy Worker to Dokku - Staging
    runs-on: ubuntu-latest
    environment: staging
    needs: [quality-checks, configure-worker-app]

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for proper git operations

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}

      - name: ğŸ—ï¸ Add SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ vars.DOKKU_HOST }} >> ~/.ssh/known_hosts

      # Deploy the application
      - name: ğŸ³ Deploy to Dokku
        uses: dokku/github-action@master
        with:
          git_remote_url: "ssh://dokku@${{ vars.DOKKU_HOST }}:22/${{ env.APP_NAME }}"
          ssh_private_key: ${{ secrets.DOKKU_SSH_PRIVATE_KEY }}
          git_push_flags: "--force"

      - name: ğŸ” Verify worker app status
        run: |
          echo "Checking worker app status..."
          ssh dokku@${{ vars.DOKKU_HOST }} ps:report ${{ env.APP_NAME }}

      - name: ğŸ“ˆ Scale processes (disable web, enable worker)
        run: |
          echo "Scaling processes: web=0, worker=1..."
          ssh dokku@${{ vars.DOKKU_HOST }} ps:scale ${{ env.APP_NAME }} web=0 worker=1 || \
            echo "Note: Process scaling may need to be done manually"

      - name: ğŸ“‹ Show worker logs
        run: |
          echo "Recent worker logs:"
          ssh dokku@${{ vars.DOKKU_HOST }} logs ${{ env.APP_NAME }} --tail 20 || true

      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ Worker deployment to staging completed successfully!"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ” Worker app: ${{ env.APP_NAME }}"
          echo "ğŸ’¡ View logs: ssh dokku@${{ vars.DOKKU_HOST }} logs ${{ env.APP_NAME }}"
