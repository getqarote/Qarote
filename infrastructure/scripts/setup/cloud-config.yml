#cloud-config
package_update: true
package_upgrade: true
packages:
  - curl # For downloading files
  - wget # For downloading files
  - git # Version control system
  - vim # Text editor
  - ufw # Uncomplicated Firewall
  - sudo # For user management
  - fail2ban # SSH protection
  - unattended-upgrades # Automatic security updates
  - chrony # Time synchronization
  - auditd # System auditing

# Create rabbithq user with sudo privileges
users:
  - name: rabbithq
    groups: [sudo]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - {{ SSH_PUBLIC_KEY }}

# Disable root SSH access and password auth
ssh_pwauth: false
disable_root: true

# Configure SSH security
ssh_config:
  PermitRootLogin: "no"
  PasswordAuthentication: "no"
  PubkeyAuthentication: "yes"
  AllowUsers: "rabbithq"
  MaxAuthTries: 3
  ClientAliveInterval: 300
  ClientAliveCountMax: 2

runcmd:
  # Configure firewall
  - ufw --force reset
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow 80/tcp # HTTP
  - ufw allow 443/tcp # HTTPS
  - ufw allow 5432/tcp # PostgreSQL
  - ufw --force enable

  # Restart SSH to apply configuration
  - systemctl restart sshd

  # Configure fail2ban for SSH protection
  - systemctl enable fail2ban
  - systemctl start fail2ban
  - |
    cat > /etc/fail2ban/jail.local << 'EOF'
    [DEFAULT]
    bantime = 3600
    findtime = 600
    maxretry = 5

    [sshd]
    enabled = true
    port = ssh
    logpath = /var/log/auth.log
    maxretry = 3
    bantime = 7200
    EOF

  - systemctl restart fail2ban

  # Enable automatic security updates
  - systemctl enable unattended-upgrades
  - systemctl start unattended-upgrades
  - |
    cat > /etc/apt/apt.conf.d/50unattended-upgrades << 'EOF'
    Unattended-Upgrade::Allowed-Origins {
        "${distro_id}:${distro_codename}-security";
        "${distro_id}ESMApps:${distro_codename}-apps-security";
        "${distro_id}ESM:${distro_codename}-infra-security";
    };
    Unattended-Upgrade::Automatic-Reboot "false";
    Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
    Unattended-Upgrade::Remove-Unused-Dependencies "true";
    EOF

  # Configure time synchronization
  - systemctl enable chrony
  - systemctl start chrony

  # Set up basic auditing
  - systemctl enable auditd
  - systemctl start auditd

    # Disable unused network services
  - systemctl disable avahi-daemon 2>/dev/null || true
  - systemctl disable cups 2>/dev/null || true
  - systemctl disable bluetooth 2>/dev/null || true

  # Create login banner
  - |
    cat > /etc/issue.net << 'EOF'
    ********************************************************************
    *                        AUTHORIZED ACCESS ONLY                     *
    * Unauthorized access to this system is forbidden and will be      *
    * prosecuted by law. By accessing this system, you agree that your *
    * actions may be monitored if unauthorized usage is suspected.     *
    ********************************************************************
    EOF

  # Ensure rabbithq user has proper setup
  - mkdir -p /home/rabbithq/.ssh
  - chown -R rabbithq:rabbithq /home/rabbithq/.ssh
  - chmod 700 /home/rabbithq/.ssh
  - chmod 600 /home/rabbithq/.ssh/authorized_keys

  # Remove root SSH keys for extra security
  - rm -f /root/.ssh/authorized_keys

  # Set up basic intrusion detection logging
  - |
    cat > /etc/logrotate.d/auth-monitor << 'EOF'
    /var/log/auth.log {
        daily
        rotate 30
        compress
        delaycompress
        missingok
        notifempty
        create 640 root adm
    }
    EOF

    # Set vim as default editor
  - update-alternatives --set editor /usr/bin/vim.basic
  - echo "export EDITOR=vim" >> /home/rabbithq/.bashrc
  - echo "export VISUAL=vim" >> /home/rabbithq/.bashrc
